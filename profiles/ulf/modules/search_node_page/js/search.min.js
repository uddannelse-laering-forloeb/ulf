/**
 * @name Search node Angular library
 * @version v1.2.7
 * @link https://github.com/search-node/searchpt
 */
angular.module("searchBoxApp",["communicationService","searchAppConfig","angular-cache"]),angular.module("searchResultApp",["communicationService","searchAppConfig","ngSanitize"]),angular.element(document).ready(function(){"use strict";var e=document.getElementById("searchResultApp");e?angular.bootstrap(e,["searchResultApp"]):console.error('Unable to bootstrap searchResultApp. Missing HTML tag with id "searchResultApp"');var r=document.getElementById("searchBoxApp");r?angular.bootstrap(r,["searchBoxApp"]):console.error('Unable to bootstrap searchBoxApp. Missing HTML tag with id "searchBoxApp"')}),angular.module("searchBoxApp").controller("boxController",["CONFIG","communicatorService","searchProxyService","$scope","$location","$rootScope","$window",function(e,r,t,o,a,n,i){"use strict";function s(){o.autocompleteString="",r.$emit("searching",{}),e.provider.hasOwnProperty("sorting")&&(o.query.sort={},o.query.sort[e.provider.sorting.field]=e.provider.sorting.order),t.search(o.query).then(function(e){t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}),r.$emit("hits",{hits:e})},function(e){console.error(e)})}function l(){var r=t.getState();o.filters=r.filters,o.template=e.templates.box,o.query={text:"",filters:{}},e.provider.hasOwnProperty("intervals")&&(o.intervals=e.provider.intervals,o.query.intervals={}),e.provider.hasOwnProperty("dates")&&(o.dates=e.provider.dates,o.query.dates={}),r.hasOwnProperty("query")?(o.query=r.query,s()):(e.provider.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),e.hasOwnProperty("initialQueryText")?(o.query.text=angular.copy(e.initialQueryText),s()):t.getFilters().then(function(e){o.filters=e},function(e){console.error(e)}))}function c(e){o.query.pager={size:e.size,page:e.page},s()}n.$on("$locationChangeSuccess",function(e,r){n.actualHash=a.hash()}),n.$watch(function(){return a.hash()},function(e,r){n.actualHash===e&&i.location.reload()}),r.$on("pager",function(e,r){var t=this.$root.$$phase;"$apply"===t||"$digest"===t?c(r):o.$apply(function(){c(r)})}),o.searchClicked=function(){o.query.hasOwnProperty("pager")&&(o.query.pager=angular.copy(e.provider.pager)),s()},o.autocomplete=function(){e.provider.hasOwnProperty("autocomplete")&&(o.autocompleteString="",o.query.text.length>=e.provider.autocomplete.minChars&&t.autocomplete(o.query.text).then(function(r){if(r.hits){var t=new RegExp("^"+o.query.text,"i"),a=r.results[0][e.provider.autocomplete.field];o.autocompleteString=a.replace(t,o.query.text)}else o.autocompleteString=""},function(e){console.error(e)}))},l()}]),angular.module("searchResultApp").controller("resultController",["CONFIG","communicatorService","$scope",function(e,r,t){"use strict";t.template=e.templates.result,t.searching=!1,e.provider.hasOwnProperty("pager")&&(t.pager=angular.copy(e.provider.pager)),t.search=function(){r.$emit("pager",t.pager)},t.hits=[],r.$on("hits",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?(t.hits=r.hits,t.searching=!1):t.$apply(function(){t.hits=r.hits,t.searching=!1})}),r.$on("searching",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?t.searching=!0:t.$apply(function(){t.searching=!0})}),r.$on("pager",function(e,r){var o=this.$root.$$phase;"$apply"===o||"$digest"===o?t.pager=r:t.$apply(function(){t.pager=r})})}]),angular.module("searchBoxApp").directive("keyCode",function(){"use strict";return{restrict:"A",link:function(e,r,t){r.bind("keypress",function(r){var o=r.which||r.keyCode;o===Number(t.code)&&e.$apply(function(){e.$eval(t.keyCode,{$event:r})})})}}}),angular.module("searchResultApp").directive("searchPager",["CONFIG",function(e){"use strict";return{restrict:"E",replace:!0,scope:!0,controller:["$scope",function(e){e.changePage=function(r){e.pager.page=r,e.search()},e.prevPage=function(){e.pager.page>0&&(e.pager.page--,e.search())},e.nextPage=function(){e.pager.page<e.pager.max-1&&(e.pager.page++,e.search())},e.$watch("hits",function(r){var t=[];if(e.pager.max=0,r.hits>e.pager.size){e.pager.max=Math.ceil(r.hits/e.pager.size);for(var o=0;o<e.pager.max;o++)t.push(o)}e.pager.pages=t})}],templateUrl:e.templates.pager}}]),angular.module("searchBoxApp").service("jsonProvider",["CONFIG","$q","$http",function(e,r,t){"use strict";var o=[];t.get(e.provider.data).then(function(e){o=e.data}),this.getFilters=function(){return{tags:{name:"Tags",type:"and",items:[{name:"Angular",value:"angular"},{name:"Developer",value:"developer"},{name:"Javascript",value:"javascript"},{name:"Chrome",value:"chrome"}]},levels:{name:"Levels (or)",type:"or",items:[{name:"First",value:1},{name:"Second",value:2},{name:"Third",value:3},{name:"Fourth",value:4}]}}},this.search=function(e){var t=this,a=angular.copy(o),n=r.defer();return""!==e.text&&(a=JSON.search(o,'//*[contains(title, "'+e.text+'")]')),angular.forEach(e.filters,function(e,r){var o=t.getFilters(),n=!1;angular.forEach(e,function(e,t){e&&("or"===o?n===!1?n="//*["+r+'="'+t+'"]':n+="|//*["+r+'="'+t+'"]':a=JSON.search(a,"//*["+r+'="'+t+'"]'))}),"or"===o&&n&&(a=JSON.search(a,n))}),n.resolve({hits:a.length,results:a}),n.promise}}]),angular.module("searchBoxApp").service("searchNodeProvider",["CONFIG","$q","$http","CacheFactory",function(e,r,t,o){"use strict";function a(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function n(){var e=r.defer();if(h)e.resolve();else{var t=document.createElement("script");t.type="text/javascript",t.readyState?t.onreadystatechange=function(){("loaded"===t.readyState||"complete"===t.readyState)&&(t.onreadystatechange=null,h=!0,e.resolve())}:t.onload=function(){h=!0,e.resolve()},t.src=f.host+"/socket.io/socket.io.js",document.getElementsByTagName("head")[0].appendChild(t)}return e.promise}function i(e){n().then(function(){p=io.connect(f.host,{query:"token="+d,"force new connection":!0,"max reconnection attempts":1/0}),p.on("error",function(r){console.error(r,"Search socket error."),e.reject(r)}),p.on("connect",function(){e.resolve("Connected to the server.")}),p.on("disconnect",function(e){})})}function s(){var e=r.defer();return void 0===p?null!==d?i(e):t.get(f.auth).success(function(r){d=r.token,i(e)}).error(function(r,t){console.error(r,"Authentication (search) to search node failed ("+t+")"),e.reject(t)}):e.resolve("Connected to the server."),e.promise}function l(e){var r={aggs:{}};for(var t in e)switch(t){case"taxonomy":for(var o=e[t],a=0;a<o.length;a++){var n=o[a];r.aggs[n.field]={terms:{field:n.field+".raw",size:0}}}break;case"boolean":for(var i=e[t],a=0;a<i.length;a++){var n=i[a];r.aggs[n.field]={terms:{field:n.field,size:0}}}break;default:console.error("Aggregation filter has unknown type - "+t)}return r}function c(r){var t={taxonomy:{},"boolean":{}};if(e.provider.hasOwnProperty("filters")){var o=e.provider.filters;for(var n in o)for(var i=o[n],s=0;s<i.length;s++){var l=angular.copy(i[s]);if(t[n][l.field]={name:l.name},0!==a(r))switch(n){case"taxonomy":t[n][l.field].items=l.terms;for(var c=0;c<r[l.field].buckets.length;c++){var u=r[l.field].buckets[c];t[n][l.field].items.hasOwnProperty(u.key)?t[n][l.field].items[u.key].count=Number(u.doc_count):console.error("Filter value don't match configuration: "+l.field+" -> "+u.key)}break;case"boolean":for(var c=0;c<r[l.field].buckets.length;c++){var u=r[l.field].buckets[c];if(t[n][l.field].count=0,"T"===u.key&&u.doc_count>0){t[n][l.field].count=Number(u.doc_count);break}}break;default:console.error("Unknown filter type used in parseFilters: "+n)}}}return t}function u(){var r={};if(e.provider.hasOwnProperty("filters")){var t=e.provider.filters;if(t.hasOwnProperty("boolean"))for(var o=0;o<t["boolean"].length;o++){var a=t["boolean"][o];r[a.field]={name:a.name}}}return r}var p,f=e.provider,h=!1,d=null;o.get("searchCache")||o.createCache("searchCache"+e.id,{maxAge:1e3*f.cacheExpire,deleteOnExpire:"aggressive",storageMode:"localStorage"});var v=o.get("searchCache"+e.id),g={taxonomy:void 0,"boolean":void 0};this.getRawFilters=function(){var r={};if(e.provider.hasOwnProperty("filters")){var t=e.provider.filters;if(t.hasOwnProperty("taxonomy")){r.taxonomy={};for(var o=0;o<t.taxonomy.length;o++){var a=t.taxonomy[o];r.taxonomy[a.field]={name:a.name,items:a.terms}}}r["boolean"]=u()}return r},this.getFilters=function(){var t=r.defer();if(e.provider.hasOwnProperty("filters"))if(void 0===g.taxonomy){var o=v.get("filters");if(void 0!==o)g=o,t.resolve(angular.copy(g));else{var a=l(e.provider.filters);s().then(function(){p.emit("count",a),p.once("counts",function(e){g=c(e),v.put("filters",g),t.resolve(g)}),p.once("searchError",function(e){console.error("Search error",e.message),t.reject(e.message)})})}}else t.resolve(angular.copy(g));else t.resolve({});return t.promise},this.search=function(t){var o={index:f.index,query:{filtered:{query:{match_all:{}}}}};if(void 0!==t.text&&""!==t.text){var n=f.fields;if(f.hasOwnProperty("boost")&&a(f.boost))for(var i in n)f.boost.hasOwnProperty(n[i])&&(n[i]=n[i]+"^"+f.boost[n[i]]);o.query.filtered.query={multi_match:{query:t.text,type:f.hasOwnProperty("match_type")?f.match_type:"best:fields",fields:n,analyzer:"string_search"}}}if(t.hasOwnProperty("sort")&&a(t.sort)>0){o.sort={};for(var u in t.sort)o.sort[u]={order:t.sort[u]}}if(t.hasOwnProperty("filters")){var h=angular.copy(t.filters),d={bool:{must:[]}};if(h.hasOwnProperty("taxonomy"))for(var u in h.taxonomy){var m=h.taxonomy[u],y={execution:"and"};y[u+".raw"]=[];for(var w in m)m[w]&&y[u+".raw"].push(w);y[u+".raw"].length&&d.bool.must.push({terms:y})}if(h.hasOwnProperty("boolean"))for(var u in h["boolean"])if(h["boolean"][u]){var w={};w[u]=h["boolean"][u],d.bool.must.push({term:w})}d.bool.must.length&&(o.query.filtered.filter=d)}if(t.hasOwnProperty("pager")&&(o.size=t.pager.size,o.from=t.pager.page*t.pager.size),e.provider.hasOwnProperty("filters")){var b=l(e.provider.filters);angular.extend(o,b)}if(t.hasOwnProperty("intervals")){o.query.filtered.hasOwnProperty("filter")||(o.query.filtered.filter={bool:{must:[]}});for(var u in t.intervals){var x={range:{}};x.range[u]={gte:t.intervals[u].from,lte:t.intervals[u].to},o.query.filtered.filter.bool.must.push(x)}}if(t.hasOwnProperty("dates")){o.query.filtered.hasOwnProperty("filter")?o.query.filtered.filter.bool.should=[]:o.query.filtered.filter={bool:{should:[]}};for(var u in t.dates){var O=f.dates[u],P={bool:{must:[{range:{}},{range:{}}]}};P.bool.must[0].range[O.from]={lte:t.dates[u].from},P.bool.must[1].range[O.to]={gt:t.dates[u].from},o.query.filtered.filter.bool.should.push(angular.copy(P)),P.bool.must[0].range[O.from]={lt:t.dates[u].to},P.bool.must[1].range[O.to]={gte:t.dates[u].to},o.query.filtered.filter.bool.should.push(angular.copy(P)),P.bool.must[0].range[O.from]={gte:t.dates[u].from},P.bool.must[1].range[O.to]={lte:t.dates[u].to},o.query.filtered.filter.bool.should.push(angular.copy(P))}}o.uuid=CryptoJS.MD5(JSON.stringify(o)).toString(),o.callbacks={hits:"hits-"+o.uuid,error:"error-"+o.uuid};var $=v.get(o.uuid),S=r.defer();return void 0!==$?($.hasOwnProperty("aggs")&&(g=c(angular.copy($.aggs))),S.resolve($)):s().then(function(){p.once(o.callbacks.hits,function(e){e.hasOwnProperty("aggs")&&(g=c(angular.copy(e.aggs)));var r=e.uuid;delete e.uuid,v.put(r,e),S.resolve(e)}),p.once(o.callbacks.error,function(e){console.error("Search error",e.message),S.reject(e.message)}),p.emit("search",o)}),S.promise},this.autocomplete=function(e){var t=r.defer();if(f.hasOwnProperty("autocomplete")){var o={index:f.autocomplete.index,query:{match_phrase_prefix:{title:{query:e}}},size:f.autocomplete.size};o.uuid=CryptoJS.MD5(JSON.stringify(o)).toString(),o.callbacks={hits:"hits-"+o.uuid,error:"error-"+o.uuid};var a=v.get(o.uuid);void 0!==a?t.resolve(a):s().then(function(){p.once(o.callbacks.hits,function(e){var r=e.uuid;delete e.uuid,v.put(r,e),t.resolve(e)}),p.once(o.callbacks.error,function(e){console.error("Auto-complete error",e.message),t.reject(e.message)}),p.emit("search",o)})}else{var n=new Error("Auto complete not configured");console.error("Search error",n.message),t.reject(n.message)}return t.promise},this.rawQuerySearch=function(e){var t=r.defer(),o=angular.clone(e);o.uuid=CryptoJS.MD5(JSON.stringify(o)).toString(),o.callbacks={hits:"hits-"+o.uuid,error:"error-"+o.uuid};var a=v.get(o.uuid);return void 0!==a?t.resolve(a):s().then(function(){p.once(o.callbacks.hits,function(e){var r=e.uuid;delete e.uuid,v.put(r,e),t.resolve(e)}),p.once(o.callbacks.error,function(e){console.error("Search error",e.message),t.reject(e.message)}),p.emit("search",o)}),t.promise}}]),angular.module("communicationService",[]).service("communicatorService",["$rootScope","$window",function(e,r){"use strict";r.rootScopes=r.rootScopes||[],r.rootScopes.push(e),this.$emit=function(e,t){angular.forEach(r.rootScopes,function(r){r.$emit(e,t)})},this.$on=function(r,t){e.$on(r,function(r,o){t.apply(e,[r,o])})}}]),angular.module("searchBoxApp").service("searchProxyService",["CONFIG","communicatorService","$injector","$location",function(e,r,t,o){"use strict";function a(e){var r=0;for(var t in e)e.hasOwnProperty(t)&&r++;return r}function n(e){var r=[];if(e.hasOwnProperty("text")&&0!==e.text.length&&r.push("text="+encodeURIComponent(e.text)),e.hasOwnProperty("filters"))for(var t in e.filters)if(0!==a(e.filters[t])){var o=e.filters[t],n=[];for(var i in o){var s=[];if("boolean"==typeof o[i]&&o[i]===!0)n.push(i);else{for(var l in o[i])o[i][l]===!0&&s.push(l);s.length&&n.push(i+":"+s.join(";"))}}n.length&&r.push("filters["+t+"]="+encodeURIComponent(n.join("?")))}if(e.hasOwnProperty("intervals")&&0!==a(e.intervals)){var c=[];for(var i in e.intervals){var u=e.intervals[i];c.push(i+";"+u.from+";"+u.to)}r.push("intervals="+encodeURIComponent(c.join("?")))}if(e.hasOwnProperty("dates")&&0!==a(e.dates)){var p=[];for(var i in e.dates){var f=e.dates[i];p.push(i+";"+f.from+";"+f.to)}r.push("dates="+encodeURIComponent(p.join("?")))}return e.hasOwnProperty("pager")&&r.push("pager="+e.pager.page+":"+e.pager.size),r.join("&")}function i(e){var r={},t=e.split("&");for(var o in t){var a=t[o].split("="),n=decodeURIComponent(a[0]);switch(-1!==n.indexOf("[")&&(n=n.substr(0,n.indexOf("["))),n){case"text":r.text=decodeURIComponent(a[1]);break;case"filters":var i=decodeURIComponent(a[0]),s=i.substr(i.indexOf("[")+1).slice(0,-1),l=decodeURIComponent(a[1]).split("?");if(l.length){r.hasOwnProperty("filters")||(r.filters={taxonomy:{},"boolean":{}});for(var c in l)switch(s){case"taxonomy":var u=l[c].split(":");r.filters[s][u[0]]=u[1].split(";").reduce(function(e,r,t){return e[r]=!0,e},{});break;case"boolean":r.filters[s][l[c]]=!0;break;default:console.error("Decoding of search hash has unknown filter type - "+s)}}break;case"intervals":var p=decodeURIComponent(a[1]).split("?");if(p.length){r.intervals={};for(var c in p){var f=p[c].split(";");r.intervals[f[0]]={from:f[1],to:f[2]}}}break;case"dates":var h=decodeURIComponent(a[1]).split("?");if(h.length){r.dates={};for(var c in h){var d=h[c].split(";");r.dates[d[0]]={from:d[1],to:d[2]}}}break;case"pager":var v=a[1].split(":");r.pager={page:Number(v[0]),size:Number(v[1])};break;default:console.error("Decoding of search hash has unknown parts - "+a[0])}}return r}var s=t.get(e.provider.service);this.getState=function(){var e={filters:this.getRawFilters()},r=o.hash();return r.length>2&&(e.query=i(r)),e},this.search=function(r,t){t="undefined"==typeof t?!1:t;var a=angular.copy(r);if(e.provider.hasOwnProperty("intervals")&&e.provider.intervals.length){if(a.hasOwnProperty("intervals"))for(var i in a.intervals)a.intervals[i].hasOwnProperty("from")&&""!==a.intervals[i].from||a.intervals[i].hasOwnProperty("to")&&""!==a.intervals[i].to||delete a.intervals[i]}else a.hasOwnProperty("intervals")&&delete a.intervals;if(t||(o.path("/"),o.hash(n(a))),e.provider.hasOwnProperty("force")&&e.provider.force.length){a.hasOwnProperty("filters")||(a.filters={});var l=e.provider.force;for(var c in l){var u=l[c];a.filters.hasOwnProperty(u.type)||(a.filters[u.type]={}),a.filters.hasOwnProperty(u.field)||(a.filters[u.type][u.field]={});for(var p in u.values)a.filters[u.type][u.field][u.values[p]]=!0}}return s.search(a)},this.autocomplete=function(e){return s.autocomplete(e)},this.rawQuerySearch=function(e){return s.rawQuerySearch(e)},this.getRawFilters=function(){return s.getRawFilters()},this.getFilters=function(){return s.getFilters()}}]);
